class Monitor

types

instance variables
  -- datos iniciales
  estudiantes: map token to Estudiante := {|->};
  docentes: map token to Docente := {|->};
  cursos: map token to Curso := {|->};
  evaluaciones: map token to Evaluacion := {|->};
  asistencias: map token to Asistencia := {|->};
  alertas: map token to Alerta := {|->};
  -- informacion 
  fecha_actual: Fecha := new Fecha(26, 11, 2025);


operations
-------------------------------- sistema de Estudiantes -------------------------------- 
-- agregar estudiante
public agregarEstudiante: token * seq of char * seq of char * nat * nat * nat ==> ()
agregarEstudiante(codigo, nombres, apellidos, dia, mes, anio) == (
  estudiantes := estudiantes ++ {codigo |-> new Estudiante(codigo, nombres, apellidos, new Fecha(dia, mes, anio))};
)
pre codigo not in set dom estudiantes;
-- obtener datos de un alumno
public obtenerDatosEstudiante: token ==> seq of char
obtenerDatosEstudiante(cod_est) == (
  return estudiantes(cod_est).getDatos()
)
pre cod_est in set dom estudiantes;
-- obtener edad de un alumno
public obtenerEdadEstudiante: token ==> nat
obtenerEdadEstudiante(cod_est) == (
  return estudiantes(cod_est).getEdad(fecha_actual)
)
pre cod_est in set dom estudiantes;
-------------------------------- sistema de Docentes -------------------------------- 
-- agregar docente
public agregarDocente: token * seq of char * seq of char ==> ()
agregarDocente(codigo, nombres, apellidos) == (
  docentes := docentes ++ {codigo |-> new Docente(codigo, nombres, apellidos)};
)
pre codigo not in set dom docentes;
-- obtener datos de un docente
public obtenerDatosDocente: token ==> seq of char
obtenerDatosDocente(cod_doc) == (
  return docentes(cod_doc).getDatos()
)
pre cod_doc in set dom docentes;
-------------------------------- sistema de Cursos -------------------------------- 
-- agregar curso con un profesor
public agregarCurso: token * token ==> ()
agregarCurso(codigo, cod_doc) == (
  cursos := cursos ++ {codigo |-> new Curso(codigo, cod_doc)};
)
pre (codigo not in set dom cursos) and (cod_doc in set dom docentes);
-- inscribir alumno a un curso
public inscribirEstudiante: token * token ==> ()
inscribirEstudiante(cod_cur, cod_est) == (
  cursos(cod_cur).inscribirEstudiante(cod_est);
)
pre (cod_cur in set dom cursos) and (cod_est in set dom estudiantes);

-- retirar alumno a un curso
public retirarEstudiante: token * token ==> ()
retirarEstudiante(cod_cur, cod_est) == (
  cursos(cod_cur).retirarEstudiante(cod_est);
)
pre (cod_cur in set dom cursos) and (cod_est in set dom estudiantes);

-- obtener alumnos de un curso
public obtenerEstudiantesCurso: token ==> set of token
obtenerEstudiantesCurso(cod_cur) == (
  return cursos(cod_cur).getEstudiantes();
)
pre cod_cur in set dom cursos;

-- total de alumnos de un curso
public totalEstudiantesCurso: token ==> nat
totalEstudiantesCurso(cod_cur) == (
  return card cursos(cod_cur).getEstudiantes();
)
pre cod_cur in set dom cursos;
-------------------------------- sistema de Evaluaciones -------------------------------- 
-- agregar una evaluacion retorna codigo
public agregarEvaluacion: Evaluacion`tipoEval * token * nat * nat * nat ==> token
agregarEvaluacion(t, cod_cur, dia, mes, anio) == (
  dcl codigo: nat := card dom evaluaciones + 1;
  evaluaciones := evaluaciones ++ {mk_token(codigo) |-> new Evaluacion(t, cod_cur, new Fecha(dia, mes, anio))};
  return mk_token(codigo)
)
pre cod_cur in set dom cursos;
-- agregar nota de la evaluacion
public agregarNota: token * token * real ==> ()
agregarNota(codigo, cod_est, nota) == (
  dcl cod_cur: token := evaluaciones(codigo).getCurso();
  if (cod_cur in set dom cursos) and (cursos(cod_cur).isMatriculado(cod_est)) -- validar si estudiante esta matriculado
    then evaluaciones(codigo).agregarNota(cod_est, nota);
)
pre (codigo in set dom evaluaciones) and (cod_est in set dom estudiantes);
-- obtener toda las notas
public obtenerNotas: token ==> map token to real
obtenerNotas(codigo) == (
  evaluaciones(codigo).getNotas();
)
pre codigo in set dom evaluaciones;
-- terminar la evaluacion
public terminarEvaluacion: token ==> ()
terminarEvaluacion(codigo) == (
  evaluaciones(codigo).terminar();
)
pre codigo in set dom evaluaciones;
-- obtener evaluaciones por curso
public obtenerEvaluacionesCurso: token ==> set of token
obtenerEvaluacionesCurso(cod_cur) == (
  return {codigo | codigo in set dom evaluaciones & evaluaciones(codigo).getCurso() = cod_cur}
)
pre cod_cur in set dom cursos;
-------------------------------- sistema de Asistencias -------------------------------- 
-- agregar una asistencia retorna codigo
public agregarAsistencia: token * nat * nat * nat ==> token
agregarAsistencia(cod_cur, dia, mes, anio) == (
  dcl codigo: nat := card dom asistencias + 1;
  asistencias := asistencias ++ {mk_token(codigo) |-> new Asistencia(cod_cur, new Fecha(dia, mes, anio))};
  return mk_token(codigo)
)
pre cod_cur in set dom cursos;
-- agregar asistencia
public registrarAsistencia: token * token ==> ()
registrarAsistencia(codigo, cod_est) == (
  dcl cod_cur: token := asistencias(codigo).getCurso();
  if (cod_cur in set dom cursos) and (cursos(cod_cur).isMatriculado(cod_est)) -- validar si estudiante esta matriculado
    then asistencias(codigo).registrarAsistencia(cod_est, true);
)
pre (codigo in set dom asistencias) and (cod_est in set dom estudiantes);
-- obtener toda las asistencias
public obtenerAsistencias: token ==> map token to bool
obtenerAsistencias(codigo) == (
  asistencias(codigo).getAsistencias();
)
pre codigo in set dom asistencias;
-- obtener evaluaciones por curso
public obtenerAsistenciasCurso: token ==> set of token
obtenerAsistenciasCurso(cod_cur) == (
  return {codigo | codigo in set dom asistencias & asistencias(codigo).getCurso() = cod_cur}
)
pre cod_cur in set dom cursos;
-- terminar las asistencias
public terminarAsistencia: token ==> ()
terminarAsistencia(codigo) == (
  dcl cod_cur: token := asistencias(codigo).getCurso();
  if cod_cur in set dom cursos then (
    dcl ests: set of token := cursos(cod_cur).getEstudiantes();
    dcl asis: map token to bool := asistencias(codigo).getAsistencias();
    dcl est_falta: set of token := ests \ (dom asis);
    for all est in set est_falta do (
      asistencias(codigo).registrarAsistencia(est, false) -- marcar ausente
    );
    asistencias(codigo).terminar();
  )
)
pre codigo in set dom asistencias;
-------------------------------- sistema de Alertas y Monitoreo -------------------------------- 
-- LLENAR 
-------------------------------- funciones extras para testear -------------------------------- 
public cargarDatos:() ==> ()
cargarDatos() == (
  agregarEstudiante(mk_token(20223014), "Joe Jhonny", "Cuadros Amanqui", 7, 4, 2004);
  agregarEstudiante(mk_token(20220575), "Misael Josias", "Marron Lope", 2, 3, 2004);
  agregarEstudiante(mk_token(20222067), "Daniel Enrique", "Marron Carcausto", 1, 12, 2004);
  agregarEstudiante(mk_token(20260001), "Joe", "Flores", 1, 2, 2004);
  agregarEstudiante(mk_token(20260002), "Jorge", "Escobedo", 1, 2, 2000);
  agregarEstudiante(mk_token(20260003), "Valentina", "Chambilla", 1, 2, 2003);
  agregarDocente(mk_token(1), "Maribel ", "Molina");
  agregarCurso(mk_token("AFEV"), mk_token(1));
);
public cargarInscripciones:() ==> ()
cargarInscripciones() == (
  inscribirEstudiante(mk_token("AFEV"), mk_token(20223014));
  inscribirEstudiante(mk_token("AFEV"), mk_token(20220575));
  inscribirEstudiante(mk_token("AFEV"), mk_token(20222067));
  inscribirEstudiante(mk_token("AFEV"), mk_token(20260001));
  inscribirEstudiante(mk_token("AFEV"), mk_token(20260002));
  inscribirEstudiante(mk_token("AFEV"), mk_token(20260003));
  retirarEstudiante(mk_token("AFEV"), mk_token(20260003));
  inscribirEstudiante(mk_token("AFEV"), mk_token(20260003));
);

public cargarEvaluaciones: () ==> ()
cargarEvaluaciones() == (
  -- Evaluacion 1
  dcl eval: token := agregarEvaluacion(<Proyecto>, mk_token("AFEV"), 6, 10, 2025);
  agregarNota(eval, mk_token(20223014), 20); 
  agregarNota(eval, mk_token(20220575), 17);
  agregarNota(eval, mk_token(20222067), 14);
  agregarNota(eval, mk_token(20260001), 11);
  agregarNota(eval, mk_token(20260002), 8);
  terminarEvaluacion(eval);
  -- Evaluacion 2
  eval := agregarEvaluacion(<Examen>, mk_token("AFEV"), 13, 10, 2025);
  agregarNota(eval, mk_token(20223014), 15); 
  agregarNota(eval, mk_token(20220575), 20);
  agregarNota(eval, mk_token(20222067), 15);
  agregarNota(eval, mk_token(20260001), 10);
  agregarNota(eval, mk_token(20260002), 5);
  agregarNota(eval, mk_token(20260003), 10);
  terminarEvaluacion(eval);
  -- Evaluacion 3
  eval := agregarEvaluacion(<Examen>, mk_token("AFEV"), 20, 10, 2025);
  agregarNota(eval, mk_token(20223014), 20); 
  agregarNota(eval, mk_token(20220575), 8);
  agregarNota(eval, mk_token(20222067), 5);
  agregarNota(eval, mk_token(20260001), 12);
  agregarNota(eval, mk_token(20260002), 15);
  agregarNota(eval, mk_token(20260003), 10);
  terminarEvaluacion(eval);
  -- Evaluacion 4
  eval := agregarEvaluacion(<Proyecto>, mk_token("AFEV"), 27, 10, 2025);
  agregarNota(eval, mk_token(20223014), 18); 
  agregarNota(eval, mk_token(20220575), 19);
  agregarNota(eval, mk_token(20260002), 11);
  agregarNota(eval, mk_token(20260003), 9);
  terminarEvaluacion(eval);

  return;
);

public cargarAsistencias: () ==> ()
cargarAsistencias() == (
  -- Asistencia 1
  dcl asis: token := agregarAsistencia(mk_token("AFEV"), 6, 10, 2025);
  registrarAsistencia(asis, mk_token(20223014));
  registrarAsistencia(asis, mk_token(20222067));
  registrarAsistencia(asis, mk_token(20260001));
  registrarAsistencia(asis, mk_token(20260003));
  terminarAsistencia(asis);
  -- Asistencia 2
  asis := agregarAsistencia(mk_token("AFEV"), 13, 10, 2025);
  registrarAsistencia(asis, mk_token(20223014));
  registrarAsistencia(asis, mk_token(20222067));
  registrarAsistencia(asis, mk_token(20260002));
  registrarAsistencia(asis, mk_token(20260003));
  terminarAsistencia(asis);
  -- Asistencia 3
  asis := agregarAsistencia(mk_token("AFEV"), 20, 10, 2025);
  registrarAsistencia(asis, mk_token(20223014));
  registrarAsistencia(asis, mk_token(20222067));
  registrarAsistencia(asis, mk_token(20220575));
  registrarAsistencia(asis, mk_token(20260001));
  registrarAsistencia(asis, mk_token(20260002));
  registrarAsistencia(asis, mk_token(20260003));
  terminarAsistencia(asis);
  -- Asistencia 4
  asis := agregarAsistencia(mk_token("AFEV"), 27, 10, 2025);
  registrarAsistencia(asis, mk_token(20223014));
  registrarAsistencia(asis, mk_token(20260002));
  registrarAsistencia(asis, mk_token(20260003));
  terminarAsistencia(asis);

  return;
);

  /* 

-------------------------------- sistema de Alertas y Monitoreo -------------------------------- 
private crearAlerta: token * token * seq of char * tipoAlerta ==> ()
crearAlerta(cod_est, cod_cur, descripcion, tipo) == (
  dcl alerta_existe: bool := exists id in set dom alertas &
    alertas(id).estudiante = cod_est and
    alertas(id).curso = cod_cur and
    alertas(id).tipo = tipo and
    (alertas(id).estado = <Creado> or alertas(id).estado = <Pendiente>);
  -- validar si no existia una similar
  if not alerta_existe then (
    dcl nueva_alerta: Alerta := mk_Alerta(cod_est, cod_cur, tipo, descripcion, <Creado>);
    contador_alerta := contador_alerta + 1;
    alertas := alertas ++ {mk_token(contador_alerta) |-> nueva_alerta}
  )
);


public analizarRiesgoSistema: () ==> ()
analizarRiesgoSistema() == (
  -- parametros 
  dcl UMBRAL_FALTAS: nat := 30;
  dcl ASISTENCIAS_MINIMAS: nat := 2;
  dcl UMBRAL_PROMEDIO: real := 10.5;
  dcl EVALUACIONES_MINIMAS: nat := 2;

  -- buscar todo los cursos
  for all cod_cur in set dom cursos do (
    dcl sesiones_curso: set of token := obtenerAsistenciasCurso(cod_cur); 
    dcl estudiantes_curso: set of token := cursos(cod_cur).getEstudiantes(); 
    dcl evals_curso: set of token := obtenerEvaluacionesCurso(cod_cur); 

    -- todo los estudiantes
    for all cod_est in set estudiantes_curso do (
      dcl faltas: nat := 0;
      dcl total_asistencia: nat := 0;
      dcl suma_notas: real := 0.0;
      dcl num_eval: nat := 0;
      dcl total_eval: nat := 0;

      dcl porcentaje_falta: real;
      dcl porcentaje_eval: real;
      dcl promedio: real;

      -- todas las asistencias
      for all id_asis in set sesiones_curso do (
        -- solo contar las terminadas
        if asistencias(id_asis).termino() then (
          dcl registro: map token to bool := asistencias(id_asis).getAsistencias(); 
          total_asistencia := total_asistencia + 1;
          if cod_est in set dom registro and registro(cod_est) = false then (
            faltas := faltas + 1;
          ) 
        )
      );

      -- todas las evaluaciones
      for all id_eval in set evals_curso do (
        -- solo contar las evaluaciones
        if evaluaciones(id_eval).termino() then ( 
          dcl notas: map token to real := evaluaciones(id_eval).getNotas(); 
          total_eval := total_eval + 1;
          -- Si el estudiante tiene nota en esta evaluaciÃ³n
          if cod_est in set dom notas then (
            suma_notas := suma_notas + notas(cod_est);
            num_eval := num_eval + 1;
          )
        )
      );

      -- tiene el minimo de asistencias totales
      if total_asistencia >= ASISTENCIAS_MINIMAS then (
        porcentaje_falta := (100.0 * faltas) / total_asistencia;
        -- si esta debajo del umbral saltar alerta
        if UMBRAL_FALTAS < porcentaje_falta then (
          dcl descripcion: seq of char :=  "Razon: " ^ porcentaje_falta ^ "% de inasistencia";
          crearAlerta(cod_est,cod_cur,descripcion,<Inasistencia>);
        );
      );

      -- tiene el minimo de evaluaciones totales
      if total_asistencia >= EVALUACIONES_MINIMAS then (
        promedio := suma_notas / total_eval;
        porcentaje_eval := (100.0 * faltas) / total_eval;
        -- si esta debajo del umbral saltar alerta
        if UMBRAL_PROMEDIO > promedio then (
          dcl descripcion: seq of char :=  "Razon: " ^ promedio ^ " promedio del curso";
          crearAlerta(cod_est,cod_cur,descripcion,<BajoRendimiento>);
        );
        -- si esta debajo del umbral saltar alerta
        if UMBRAL_FALTAS < porcentaje_falta then (
          dcl descripcion: seq of char :=  "Razon: " ^ porcentaje_falta ^ "% sin evaluaciones";
          crearAlerta(cod_est,cod_cur,descripcion,<FaltaEvaluacion>);
        );
      );
    ) 
  )
);

public obtenerAlertas: () ==> map token to Alerta
obtenerAlertas() == (
  return alertas
);
public obtenerTiposAlertas: tipoAlerta ==> map token to Alerta
obtenerTiposAlertas(tipo) == (
  dcl conjunto_alertas: set of Alerta := {};
  -- extraer todas la alertas
  for all alerta in set rng alertas do (
    if alerta.tipo = tipo then (
      conjunto_alertas := conjunto_alertas union {alerta};
    )
  );
  return alertas :> conjunto_alertas 
);
public obtenerAlertasCurso: token ==> map token to Alerta
obtenerAlertasCurso(codigo) == (
  dcl conjunto_alertas: set of Alerta := {};
  -- extraer todas la alertas
  for all alerta in set rng alertas do (
    if alerta.curso = codigo then (
      conjunto_alertas := conjunto_alertas union {alerta};
    )
  );
  return alertas :> conjunto_alertas 
)
pre codigo in set dom cursos;
public obtenerAlertasEstudiante: token ==> map token to Alerta
obtenerAlertasEstudiante(codigo) == (
  dcl conjunto_alertas: set of Alerta := {};
  -- extraer todas la alertas
  for all alerta in set rng alertas do (
    if alerta.estudiante = codigo then (
      conjunto_alertas := conjunto_alertas union {alerta};
    )
  );
  return alertas :> conjunto_alertas 
)
pre codigo in set dom estudiantes;

public obtenerAlertasDocente: token ==> map token to Alerta
obtenerAlertasDocente(codigo) == (
  dcl conjunto_cursos: set of token := {};
  dcl conjunto_alertas: set of Alerta := {};
  -- extraer todas los cursos
  for all curso in set rng cursos do (
    if curso.getDocente() = codigo then (
      conjunto_cursos := conjunto_cursos union {curso.getCodigo()};
    )
  );

  -- extraer todas la alertas
  for all alerta in set rng alertas do (
    if alerta.curso in set conjunto_cursos then (
      conjunto_alertas := conjunto_alertas union {alerta};
    )
  );
  return alertas :> conjunto_alertas 
)
pre codigo in set dom docentes;

public validarAlerta: token ==> ()
validarAlerta(codigo) == (
  alertas(codigo).estado := <Pendiente>;
)
pre codigo in set dom alertas and alertas(codigo).estado = <Creado>;

public descartarAlerta: token ==> ()
descartarAlerta(codigo) == (
  alertas(codigo).estado := <Archivado>;
)
pre codigo in set dom alertas and (alertas(codigo).estado = <Creado> or alertas(codigo).estado = <Pendiente>);

public concluirAlerta: token ==> ()
concluirAlerta(codigo) == (
  alertas(codigo).estado := <Concluido>;
)
pre codigo in set dom alertas and (alertas(codigo).estado = <Pendiente>);

-------------------------------- funciones extras para testear -------------------------------- 
public cargarAlertas: () ==> ()
cargarAlertas() == (
  validarAlerta(mk_token(1));
  descartarAlerta(mk_token(2));
  concluirAlerta(mk_token(1));
  validarAlerta(mk_token(3));
  descartarAlerta(mk_token(3));
  validarAlerta(mk_token(4));
);
*/

end Monitor